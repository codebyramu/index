<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Learn With Me - Carnatic Music (Progress + History)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%8E%B6%3C/text%3E%3C/svg%3E">
<style>
:root{
--color-primary:#6DD5FA;
--color-secondary:#FF7A9F;
--color-dark:#222;
--color-light:#f6f8fb;
--color-highlight:#ffc107;
--color-success:#28a745;
--color-pro:#8A2BE2;
--shadow: 0 6px 18px rgba(15,15,15,0.08);
--glass: rgba(255,255,255,0.7);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter, Arial, sans-serif}
body{background:linear-gradient(180deg,#fbfdff 0%, var(--color-light) 100%);color:var(--color-dark);min-height:100vh;display:flex;flex-direction:column}
header{background-image:linear-gradient(90deg,var(--color-primary),var(--color-secondary));color:#fff;padding:18px 12px;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 6px 16px rgba(0,0,0,0.08);flex-wrap:wrap;gap:8px}
header h1{font-size:20px;font-weight:700}
.mobile-menu-toggle{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;color:white;font-size:20px;display:none;cursor:pointer}
@media(max-width:768px){.mobile-menu-toggle{display:block}}
.app-wrap{display:flex;flex:1;max-width:1400px;margin:18px auto;width:100%;gap:18px;padding:0 12px}
aside.sidebar{width:300px;background:white;border-radius:16px;padding:16px;box-shadow:var(--shadow);flex-shrink:0;background:linear-gradient(180deg,#ffffff,#f7f9ff)}
@media(max-width:768px){aside.sidebar{position:fixed;left:-320px;top:80px;height:calc(100% - 100px);z-index:200;transition:left .28s;overflow:auto}aside.sidebar.open{left:8px}}

.sidebar-button{display:block;width:100%;padding:10px 12px;border-radius:999px;border:none;background:var(--color-primary);color:#fff;font-weight:700;margin-bottom:10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:transform .16s, box-shadow .16s}
.sidebar-button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,0.12)}

.category-group{margin-bottom:14px}

.category-header-card{
display:flex;
align-items:center;
justify-content:space-between;
padding:10px 12px;
border-radius:12px;
background:linear-gradient(135deg,rgba(109,213,250,0.18),rgba(255,122,159,0.18));
cursor:pointer;
transition:transform .16s, box-shadow .16s, background .16s;
}
.category-header-main{
display:flex;
align-items:center;
gap:8px;
}
.category-icon{
width:30px;
height:30px;
border-radius:999px;
display:flex;
align-items:center;
justify-content:center;
background:rgba(255,255,255,0.9);
font-size:16px;
}
.category-title-text{
display:flex;
flex-direction:column;
}
.category-title-text span:first-child{
font-weight:700;
font-size:0.95rem;
}
.category-title-text span:last-child{
font-size:0.8rem;
color:#555;
}
.category-badge{
font-size:0.75rem;
padding:4px 8px;
border-radius:999px;
background:rgba(255,255,255,0.95);
color:#333;
font-weight:600;
}
.category-header-card:hover{
transform:translateY(-1px);
box-shadow:0 8px 22px rgba(0,0,0,0.12);
background:linear-gradient(135deg,rgba(109,213,250,0.26),rgba(255,122,159,0.26));
}

.category-chevron{
font-size:14px;
color:#444;
transition:transform .18s ease;
}
.category-header-card.expanded .category-chevron{
transform:rotate(90deg);
}

.lesson-section-title{
font-size:0.8rem;
font-weight:700;
margin-top:8px;
margin-bottom:4px;
color:#666;
text-transform:uppercase;
letter-spacing:0.04em;
}

.lesson-list{
margin-top:4px;
padding-left:2px;
max-height:0;
overflow:hidden;
transition:max-height .3s ease;
}
.lesson-list.expanded{
max-height:550px;
}

.lesson-item{
display:flex;
align-items:center;
gap:10px;
padding:8px 10px;
border-radius:10px;
cursor:pointer;
margin-bottom:6px;
font-size:0.9rem;
background:#ffffff;
box-shadow:0 3px 10px rgba(0,0,0,0.04);
border-left:4px solid rgba(138,43,226,0.28);
transition:transform .14s, box-shadow .14s, background .14s, border-color .14s;
}
.lesson-item:hover{
transform:translateY(-1px);
box-shadow:0 6px 16px rgba(0,0,0,0.10);
background:linear-gradient(90deg,rgba(255,255,255,1),rgba(248,251,255,1));
}
.lesson-item.completed{
border-color:var(--color-success);
}
.lesson-item.pending{
border-color:rgba(255,193,7,0.7);
}

.lesson-item label{
flex:1;
cursor:pointer;
font-weight:600;
}
.lesson-meta-chip{
font-size:0.7rem;
padding:3px 8px;
border-radius:999px;
background:rgba(0,0,0,0.04);
color:#555;
font-weight:600;
text-transform:uppercase;
letter-spacing:0.04em;
}
.lesson-meta-chip.done{
background:rgba(40,167,69,0.1);
color:var(--color-success);
}
.lesson-meta-chip.todo{
background:rgba(255,193,7,0.12);
color:#b88700;
}
.lesson-item input[type="checkbox"]{
width:16px;
height:16px;
accent-color:var(--color-pro);
}

main.main-content{flex:1}
.panel{background:white;padding:18px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:14px}
.sequence-display {
display:flex;
gap:10px;
padding:14px;
border-radius:10px;
min-height:80px;
align-items:flex-start;
flex-wrap:wrap;
overflow-y:auto;
overflow-x:hidden;
}
.note{min-width:42px;padding:10px 12px;border-radius:8px;background:#f0f0f0;font-weight:700;text-align:center;cursor:pointer;transition:transform .14s, box-shadow .14s}
.note.highlighted{background:var(--color-highlight);box-shadow:0 6px 18px rgba(255,193,7,0.15);transform:scale(1.06)}
.note.prolonged-2{min-width:68px;background:#d1e7dd}
.note.prolonged-3{min-width:92px;background:#ffeac4}
.note.prolonged-05{min-width:28px;padding:8px;background:#ffdede}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
.controls .group{display:flex;gap:8px;align-items:center}
input[type=number], select{padding:8px;border-radius:8px;border:1px solid #ddd}
.control-button{padding:10px 16px;border-radius:999px;border:none;color:#fff;font-weight:700;cursor:pointer}
.play{background:var(--color-success)}
.pause{background:var(--color-highlight);color:#222}
.stop{background:#dc3545}
.small-muted{font-size:0.9rem;color:#666}
.name-group{display:flex;align-items:center;gap:8px;margin-left:8px}
.name-group input{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);color:#fff;min-width:120px}
.name-group input::placeholder{color:rgba(255,255,255,0.8)}
.name-greeting{font-size:0.95rem;font-weight:500}
/* Dashboard modal */
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(880px,95%);z-index:300;background:white;border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.18);display:none}
.modal.open{display:block}
.modal .row{display:flex;gap:12px;flex-wrap:wrap}
.stat-card{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbff);box-shadow:0 8px 30px rgba(10,10,40,0.04);min-width:160px}
.history-list{max-height:220px;overflow:auto;padding:8px;margin-top:10px}
.muted{color:#666;font-size:0.9rem}
.btn-ghost{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:transparent;cursor:pointer}
footer{padding:12px;text-align:center;color:#777;font-size:0.9rem}
.hidden{display:none}
</style>
</head>
<body>
<header>
<h1>Learn With Me üé∂</h1>
<div class="name-group">
<span class="name-greeting" id="name-greeting">Hi, learner!</span>
<input id="name-input" type="text" placeholder="Enter your name" />
</div>
<button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Open menu">‚ò∞</button>
</header>

<div class="app-wrap">
<aside class="sidebar" id="sidebar">
<button id="toggle-lessons-button" class="sidebar-button">üìö Learn Lessons</button>

<div id="lesson-categories"></div>

<button id="pro-mode-button" class="sidebar-button" style="background:var(--color-pro)">üéØ Learn Like a Pro</button>

<button id="progress-button" class="sidebar-button" style="background:linear-gradient(90deg,var(--color-secondary),var(--color-pro))">üìä Progress Dashboard</button>

<button id="history-toggle-button" class="sidebar-button" style="background:#444">üìú History</button>

<div style="margin-top:12px;font-size:0.95rem;color:#555">
Currently: <div id="current-lesson-summary" class="small-muted">Select a lesson</div>
</div>
</aside>

<main class="main-content">
<div class="panel">
<h2>Current Lesson: <span id="current-lesson-name">None Selected</span></h2>
<div class="sequence-display panel" id="sequence-display">Select a lesson to see the notes here.</div>

<div class="controls">
<div class="group">
<label for="play-bpm-input" class="small-muted">BPM</label>
<input id="play-bpm-input" type="number" value="60" min="10" max="300" />
</div>
<div class="group">
<label class="small-muted">Instrument</label>
<select id="instrument-select">
<option value="sine">Sine Wave</option>
<option value="piano">Piano (triangle)</option>
<option value="keyboard">Keyboard (smooth)</option>
</select>
</div>
<div class="group">
<label class="small-muted">Shruti (Sa)</label>
<select id="shruti-select">
<option value="261.63">C (261.63 Hz)</option>
<option value="277.18">C# / D‚ô≠ (277.18 Hz)</option>
<option value="293.66" selected>D (293.66 Hz)</option>
<option value="311.13">D# / E‚ô≠ (311.13 Hz)</option>
<option value="329.63">E (329.63 Hz)</option>
<option value="349.23">F (349.23 Hz)</option>
<option value="369.99">F# / G‚ô≠ (369.99 Hz)</option>
<option value="392.00">G (392.00 Hz)</option>
<option value="415.30">G# / A‚ô≠ (415.30 Hz)</option>
<option value="440.00">A (440.00 Hz)</option>
<option value="466.16">A# / B‚ô≠ (466.16 Hz)</option>
<option value="493.88">B (493.88 Hz)</option>
</select>
</div>

<button id="play-button" class="control-button play">‚ñ∂Ô∏è Play</button>
<button id="pause-button" class="control-button pause" disabled>‚è∏Ô∏è Pause</button>
<button id="stop-button" class="control-button stop" disabled>‚èπÔ∏è Stop</button>
</div>
</div>

<div id="history-panel" class="panel hidden">
<h3>Your Learning History</h3>
<div id="history-list" class="history-list muted">No history yet.</div>
</div>
</main>
</div>

<!-- Progress Dashboard Modal -->
<div id="dashboard-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<h3>Progress Dashboard</h3>
<div>
<button id="clear-history-btn" class="btn-ghost">Clear History</button>
<button id="clear-progress-btn" class="btn-ghost">Clear Progress</button>
<button id="close-dashboard" class="btn-ghost">Close</button>
</div>
</div>

<div class="row">
<div class="stat-card">
<div class="muted">Total Lessons</div>
<div id="stat-total" style="font-size:18px;font-weight:700">0</div>
</div>
<div class="stat-card">
<div class="muted">Completed</div>
<div id="stat-completed" style="font-size:18px;font-weight:700">0</div>
</div>
<div class="stat-card">
<div class="muted">Lessons Learned</div>
<div id="stat-learned" style="font-size:18px;font-weight:700">0</div>
</div>
<div class="stat-card">
<div class="muted">Pending Lessons</div>
<div id="stat-pending" style="font-size:18px;font-weight:700">0</div>
</div>
<div class="stat-card">
<div class="muted">Progress</div>
<div id="stat-percent" style="font-size:18px;font-weight:700">0%</div>
</div>
<div class="stat-card">
<div class="muted">Streak</div>
<div id="stat-streak" style="font-size:18px;font-weight:700">0 days</div>
</div>
</div>

<div style="margin-top:12px">
<div class="muted">Last Opened</div>
<div id="stat-last-opened" style="font-weight:700;margin-bottom:8px">‚Äî</div>

<div class="muted">Recent History</div>
<div id="dashboard-history-list" class="history-list muted">No recent history.</div>
</div>
</div>

<footer>Built with ‚ù§Ô∏è ‚Äî Learn With Me</footer>

<script>
/* ========= DATA ========= */
const LESSON_NOTES_DATA = {
'Sarali Varusai': [
['s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','r','s'],
['s','r','s','r','s','r','g','m','s','r','g','m','p','d','n','sa','sa','n','sa','n','sa','n','d','p','sa','n','d','p','m','g','r','s'],
['s','r','g','s','r','g','s','r','s','r','g','m','p','d','n','sa','sa','n','d','sa','n','d','sa','n','sa','n','d','p','m','g','r','s'],
['s','r','g','m','s','r','g','m','s','r','g','m','p','d','n','sa','sa','n','d','p','sa','n','d','p','sa','n','d','p','m','g','r','s'],
['s','r','g','m','p_2','s','r','s','r','g','m','p','d','n','sa','sa','n','d','p','m_2','sa','n','sa','n','d','p','m','g','r','s'],
['s','r','g','m','p','d','s','r','s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','sa','n','sa','n','d','p','m','g','r','s'],
['s','r','g','m','p','d','n_2','s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','r_2','sa','n','d','p','m','g','r','s']
],
'Jandai Varusai': [
['s','s','r','r','g','g','m','m','p','p','d','d','n','n','sa','sa','sa','sa','n','n','d','d','p','p','m','m','g','g','r','r','s','s'],
['s','s','r_2','s','s','r_2','s','r','s','s','r','r','g','g','m','m','r','r','g_2','r','r','g_2','r','g','r','r','g','g','m','m','p','p'],
['s','r','g','m','p','d','n','sa','s','r','g','m','p','d','n','sa']
],
'Sarali Malai': [
['s','r','s','r','s','r','g','m','s','r','g','s','r','g','s','r','s','r','g','m','s','r','g','m','s','r','g','m','p_2','s','r','s','r','g','m','p','d','s','r','s','r','g','m','p','d','n_2','s','r','g','m','p','m','g','r','s']
],
'new Varusai':[['s','n']]
};

/* ========= APP STATE ========= */
let currentLessonData = [];
let currentLessonName = 'None Selected';
let currentLessonCategory = null;
let currentNoteIndex = 0;
let isPlaying = false;
let isProMode = false;
let currentTimeoutId = null;
let bpm = 60;
let selectedInstrument = 'sine';
let baseSaFrequency = 293.66;
let userName = '';

/* ========= AUDIO SETUP ========= */
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
document.addEventListener('click', () => {
if (audioContext && audioContext.state === 'suspended') audioContext.resume();
}, { once: true });

const NOTE_RATIOS = {
's':1.0000,'r':1.1225,'g':1.2599,'m':1.3348,'p':1.4983,'d':1.6818,'n':1.8877,'sa':2.0000
};
function getFrequency(note) {
const r = NOTE_RATIOS[note];
return r ? baseSaFrequency * r : 0;
}

// shared oscillator for "keyboard" instrument (continuous sound)
let keyboardOsc = null;
let keyboardGain = null;
function ensureKeyboardOsc(){
if (keyboardOsc) return;
const now = audioContext.currentTime;
keyboardOsc = audioContext.createOscillator();
keyboardGain = audioContext.createGain();
keyboardOsc.type = 'sine';
keyboardGain.gain.setValueAtTime(0.5, now);
keyboardOsc.connect(keyboardGain);
keyboardGain.connect(audioContext.destination);
keyboardOsc.start(now);
}
function stopKeyboardOsc(){
if (keyboardOsc){
const now = audioContext.currentTime;
keyboardGain.gain.linearRampToValueAtTime(0.0001, now + 0.05);
keyboardOsc.stop(now + 0.06);
keyboardOsc = null;
keyboardGain = null;
}
}

function playNote(noteName, duration, type='sine'){
const freq = getFrequency(noteName);
if (!freq) return;
const now = audioContext.currentTime;

// keyboard: smooth sustained tone until next note
if (type === 'keyboard'){
ensureKeyboardOsc();
keyboardOsc.frequency.cancelScheduledValues(now);
keyboardOsc.frequency.setValueAtTime(freq, now);
return;
}

const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.type = (type==='piano') ? 'triangle' : 'sine';
osc.frequency.setValueAtTime(freq, now);
gain.gain.setValueAtTime(0, now);
gain.gain.linearRampToValueAtTime(0.6, now + 0.01);
gain.gain.linearRampToValueAtTime(0.4, now + duration * 0.7);
gain.gain.linearRampToValueAtTime(0.0001, now + duration);
osc.connect(gain);
gain.connect(audioContext.destination);
osc.start(now);
osc.stop(now + duration + 0.02);
}

/* ========= LOCAL STORAGE KEYS ========= */
const KEY_HISTORY = 'lwm_history';
const KEY_PROGRESS = 'lwm_progress';
const KEY_NAME = 'lwm_username';

/* ========= HISTORY & PROGRESS HELPERS ========= */
function loadHistory(){
try { return JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]'); }
catch(e){ return []; }
}
function saveHistory(h){
localStorage.setItem(KEY_HISTORY, JSON.stringify(h));
}
function addHistoryEntry(lessonFullName){
const hist = loadHistory();
const now = new Date();
hist.unshift({ lesson: lessonFullName, ts: now.toISOString() });
if (hist.length > 300) hist.splice(300);
saveHistory(hist);
renderHistoryPanel();
renderDashboardStats();
}

function loadProgress(){
try { return JSON.parse(localStorage.getItem(KEY_PROGRESS) || '{}'); }
catch(e){ return {}; }
}
function saveProgress(p){
localStorage.setItem(KEY_PROGRESS, JSON.stringify(p));
}
function markLessonCompleted(keyName, done){
const p = loadProgress();
p[keyName] = !!done;
saveProgress(p);
renderLessonLists();
renderDashboardStats();
}

/* ========= STREAK CALCULATION ========= */
function calculateStreak(){
const hist = loadHistory();
if (!hist.length) return 0;
const days = [...new Set(hist.map(h => h.ts.slice(0,10)))];
days.sort((a,b)=>b.localeCompare(a));
let streak = 0;
let expected = new Date();
for (let i=0;i<days.length;i++){
const day = days[i];
const expectedStr = expected.toISOString().slice(0,10);
if (day === expectedStr){
streak++;
expected.setDate(expected.getDate() - 1);
} else {
break;
}
}
return streak;
}

/* ========= RENDERING ========= */
const lessonCategoriesEl = document.getElementById('lesson-categories');
const sequenceDisplayEl = document.getElementById('sequence-display');
const lessonNameEl = document.getElementById('current-lesson-name');
const currentLessonSummaryEl = document.getElementById('current-lesson-summary');
const historyListEl = document.getElementById('history-list');
const historyPanelEl = document.getElementById('history-panel');

function humanLessonName(category, idx){
return `${category.split(' ')[0]} L${idx+1}`;
}
function renderLessonLists(){
lessonCategoriesEl.innerHTML = '';
const progress = loadProgress();
Object.keys(LESSON_NOTES_DATA).forEach(category => {
const container = document.createElement('div');
container.className = 'category-group';

const lessonCount = LESSON_NOTES_DATA[category].length;
const completedInCat = Object.keys(progress)
  .filter(k => k.startsWith(category+'|') && progress[k]).length;
const pendingInCat = lessonCount - completedInCat;

// pick a small icon per category
let icon = 'üéµ';
if (category.toLowerCase().includes('sarali')) icon = 'üéµ';
if (category.toLowerCase().includes('jandai')) icon = 'üéµ';

// header card
const headerCard = document.createElement('div');
headerCard.className = 'category-header-card';

const headerMain = document.createElement('div');
headerMain.className = 'category-header-main';

const iconEl = document.createElement('div');
iconEl.className = 'category-icon';
iconEl.textContent = icon;

const titleBox = document.createElement('div');
titleBox.className = 'category-title-text';
const titleTop = document.createElement('span');
titleTop.textContent = category;
const titleBottom = document.createElement('span');
titleBottom.textContent = `${lessonCount} lesson${lessonCount>1?'s':''}`;
titleBox.appendChild(titleTop);
titleBox.appendChild(titleBottom);

headerMain.appendChild(iconEl);
headerMain.appendChild(titleBox);

const badge = document.createElement('div');
badge.className = 'category-badge';
badge.textContent = `Learned ${completedInCat} ‚Ä¢ Pending ${pendingInCat}`;

const chevron = document.createElement('div');
chevron.className = 'category-chevron';
chevron.textContent = '‚ñ∂';

headerCard.appendChild(headerMain);
headerCard.appendChild(badge);
headerCard.appendChild(chevron);

// lesson list container
const list = document.createElement('div');
list.className = 'lesson-list';

const learnedTitle = document.createElement('div');
learnedTitle.textContent = 'Lessons Learned';
learnedTitle.className = 'lesson-section-title';

const pendingTitle = document.createElement('div');
pendingTitle.textContent = 'Pending Lessons';
pendingTitle.className = 'lesson-section-title';

const learnedList = document.createElement('div');
const pendingList = document.createElement('div');

LESSON_NOTES_DATA[category].forEach((lessonArr, i) => {
const keyName = `${category}|L${i+1}`;
const isDone = !!progress[keyName];

const li = document.createElement('div');
li.className = 'lesson-item ' + (isDone ? 'completed' : 'pending');

const chk = document.createElement('input');
chk.type = 'checkbox';
chk.checked = isDone;
chk.addEventListener('change', (e)=>{
  markLessonCompleted(keyName, e.target.checked);
});

const label = document.createElement('label');
label.textContent = humanLessonName(category, i);
label.addEventListener('click', ()=>{
  handleStandardLessonSelection(category, i);
});

const chip = document.createElement('div');
chip.className = 'lesson-meta-chip ' + (isDone ? 'done' : 'todo');
chip.textContent = isDone ? 'Done' : 'Practice';

li.appendChild(chk);
li.appendChild(label);
li.appendChild(chip);

if (isDone) {
  learnedList.appendChild(li);
} else {
  pendingList.appendChild(li);
}
});

if (learnedList.children.length) {
list.appendChild(learnedTitle);
list.appendChild(learnedList);
}
if (pendingList.children.length) {
list.appendChild(pendingTitle);
list.appendChild(pendingList);
}

// expand / collapse on header click
headerCard.addEventListener('click', ()=>{
const isExpanded = list.classList.contains('expanded');
document.querySelectorAll('.lesson-list').forEach(el=>el.classList.remove('expanded'));
document.querySelectorAll('.category-header-card').forEach(el=>el.classList.remove('expanded'));
if (!isExpanded){
  list.classList.add('expanded');
  headerCard.classList.add('expanded');
}
});

container.appendChild(headerCard);
container.appendChild(list);
lessonCategoriesEl.appendChild(container);
});
}

/* render sequence (notes) */
function parseNote(fullNote){
const parts = fullNote.split('_');
const note = parts[0];
let multiplier = 1;
if (parts.length>1){ multiplier = parseFloat(parts[1]); if (isNaN(multiplier)) multiplier = 1; }
let visualClass = '';
if (multiplier === 2) visualClass = 'prolonged-2';
else if (multiplier === 3) visualClass = 'prolonged-3';
else if (multiplier === 0.5) visualClass = 'prolonged-05';
return { note, multiplier, visualClass };
}
function renderSequence(){
sequenceDisplayEl.innerHTML = '';
if (!currentLessonData.length){
sequenceDisplayEl.textContent = 'Select a lesson to see the notes here.';
return;
}
currentLessonData.forEach((n,i)=>{
const { note, visualClass } = parseNote(n);
const el = document.createElement('div');
el.className = 'note';
if (visualClass) el.classList.add(visualClass);
if (i === currentNoteIndex) el.classList.add('highlighted');
el.textContent = note.toUpperCase();
el.addEventListener('click', ()=>{
stopPlayback();
currentNoteIndex = i;
renderSequence();
});
sequenceDisplayEl.appendChild(el);
});
const h = sequenceDisplayEl.querySelector('.note.highlighted');
if (h) h.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
}

/* HISTORY rendering */
function renderHistoryPanel(){
const hist = loadHistory();
if (!hist.length){
historyListEl.innerHTML = '<div class="muted">No history yet.</div>';
document.getElementById('dashboard-history-list').innerHTML = '<div class="muted">No recent history.</div>';
return;
}
historyListEl.innerHTML = '';
const show = hist.slice(0, 30);
show.forEach(it => {
const d = new Date(it.ts);
const li = document.createElement('div');
li.style.marginBottom = '8px';
li.innerHTML = `<strong>${it.lesson}</strong><div class="muted" style="font-size:0.85rem">${d.toLocaleString()}</div>`;
historyListEl.appendChild(li);
});

const dash = document.getElementById('dashboard-history-list');
dash.innerHTML = '';
show.slice(0,10).forEach(it=>{
const d = new Date(it.ts);
const el = document.createElement('div');
el.style.marginBottom = '6px';
el.innerHTML = `<strong>${it.lesson}</strong> <div class="muted" style="font-size:0.85rem">${d.toLocaleString()}</div>`;
dash.appendChild(el);
});
}

/* DASHBOARD stats */
function renderDashboardStats(){
const categories = Object.keys(LESSON_NOTES_DATA);
let total = 0;
categories.forEach(c=> total += LESSON_NOTES_DATA[c].length);
const progress = loadProgress();
let completed = Object.keys(progress).filter(k=>progress[k]).length;
const percent = total ? Math.round((completed/total)*100) : 0;
const hist = loadHistory();
const lastOpened = hist.length ? hist[0].lesson : '‚Äî';
const streak = calculateStreak();
document.getElementById('stat-total').textContent = total;
document.getElementById('stat-completed').textContent = completed;
document.getElementById('stat-learned').textContent = completed;
document.getElementById('stat-pending').textContent = total - completed;
document.getElementById('stat-percent').textContent = `${percent}%`;
document.getElementById('stat-last-opened').textContent = lastOpened;
document.getElementById('stat-streak').textContent = `${streak} day${streak===1?'':'s'}`;
}

/* ========= PLAYBACK ========= */
function playback(onFinish=null){
if (!isPlaying) return;
if (currentNoteIndex >= currentLessonData.length){
renderSequence();
if (onFinish) onFinish();
else {
currentNoteIndex = 0;
currentTimeoutId = setTimeout(()=>playback(onFinish), 800);
}
return;
}
const raw = currentLessonData[currentNoteIndex];
const { note, multiplier } = parseNote(raw);
const baseMs = 60000 / bpm;
const durMs = baseMs * multiplier;
const durS = durMs/1000;
playNote(note, durS, selectedInstrument);
renderSequence();
currentNoteIndex++;
currentTimeoutId = setTimeout(()=>playback(onFinish), durMs);
}

/* controls */
const bpmInput = document.getElementById('play-bpm-input');
const instrSelect = document.getElementById('instrument-select');
const shrutiSelect = document.getElementById('shruti-select');
const playBtn = document.getElementById('play-button');
const pauseBtn = document.getElementById('pause-button');
const stopBtn = document.getElementById('stop-button');

bpmInput.addEventListener('input', (e)=> {
const v = parseInt(e.target.value) || 60;
bpm = Math.max(10,Math.min(300,v));
});
instrSelect.addEventListener('change', e => {
selectedInstrument = e.target.value;
if (selectedInstrument !== 'keyboard'){
stopKeyboardOsc();
}
});
shrutiSelect.addEventListener('change', e => baseSaFrequency = parseFloat(e.target.value));

playBtn.addEventListener('click', ()=>{
if (!currentLessonData.length){ alert('Select a lesson first!'); return; }
if (audioContext.state === 'suspended') audioContext.resume();
stopPlayback();
isPlaying = true;
updateControlButtons();
playback();
});
pauseBtn.addEventListener('click', ()=>{
isPlaying = false;
clearTimeout(currentTimeoutId);
updateControlButtons();
});
stopBtn.addEventListener('click', stopPlayback);

function stopPlayback(){
isPlaying = false;
isProMode = false;
clearTimeout(currentTimeoutId);
currentNoteIndex = 0;
renderSequence();
updateControlButtons();
stopKeyboardOsc();
}
function updateControlButtons(){
playBtn.disabled = isPlaying;
pauseBtn.disabled = !isPlaying;
stopBtn.disabled = !isPlaying && currentNoteIndex === 0;
bpmInput.disabled = isPlaying && isProMode;
instrSelect.disabled = isPlaying;
shrutiSelect.disabled = isPlaying;
}

/* ========= LESSON SELECTION HANDLERS ========= */
function handleStandardLessonSelection(categoryName, index){
stopPlayback();
currentLessonCategory = categoryName;
currentLessonData = LESSON_NOTES_DATA[categoryName][index].slice();
currentLessonName = `${humanLessonName(categoryName,index)}`;
lessonNameEl.textContent = currentLessonName;
currentLessonSummaryEl.textContent = `${categoryName} ‚Ä¢ ${currentLessonName}`;
currentNoteIndex = 0;
renderSequence();
addHistoryEntry(currentLessonName);
renderDashboardStats();
}

/* ========= PRO MODE ========= */
const PRO_MODE_STEPS = [
{bpm:60,repeats:1,label:'Slow (x1)'},
{bpm:120,repeats:2,label:'Medium (x2)'},
{bpm:240,repeats:4,label:'Fast (x4)'}
];
let proCategoryName=null, proLessonIndex=0, proStep=0, proRepeatCount=0;
function startProMode(categoryName){
stopPlayback();
proCategoryName = categoryName;
proLessonIndex = 0;
isProMode = true;
isPlaying = true;
proceedProLesson();
}
function proceedProLesson(){
if (!isProMode) return;
const lessons = LESSON_NOTES_DATA[proCategoryName];
if (proLessonIndex >= lessons.length){
alert('Pro mode finished for '+proCategoryName);
stopPlayback();
return;
}
currentLessonData = lessons[proLessonIndex].slice();
currentLessonName = `${proCategoryName.split(' ')[0]} L${proLessonIndex+1}`;
lessonNameEl.textContent = currentLessonName;
proStep = 0;
proRepeatCount = 0;
proStepLoop();
}
function proStepLoop(){
const step = PRO_MODE_STEPS[proStep];
if (!step){ proLessonIndex++; proceedProLesson(); return; }
bpm = step.bpm;
bpmInput.value = bpm;
proRepeatCount = 0;
const doRepeat = ()=>{
if (!isProMode) return;
if (proRepeatCount < step.repeats){
proRepeatCount++;
currentNoteIndex = 0;
playback(()=> doRepeat());
} else {
proStep++;
proStepLoop();
}
};
doRepeat();
}

/* ========= HISTORY & DASHBOARD UI ========= */
document.getElementById('progress-button').addEventListener('click', ()=>{
document.getElementById('dashboard-modal').classList.add('open');
renderDashboardStats();
renderHistoryPanel();
});
document.getElementById('close-dashboard').addEventListener('click', ()=>{
document.getElementById('dashboard-modal').classList.remove('open');
});
document.getElementById('clear-history-btn').addEventListener('click', ()=>{
if (!confirm('Clear all history?')) return;
localStorage.removeItem(KEY_HISTORY);
renderHistoryPanel();
renderDashboardStats();
});
document.getElementById('clear-progress-btn').addEventListener('click', ()=>{
if (!confirm('Clear all completion progress?')) return;
localStorage.removeItem(KEY_PROGRESS);
renderLessonLists();
renderDashboardStats();
});

document.getElementById('toggle-lessons-button').addEventListener('click', ()=>{
const isShown = lessonCategoriesEl.style.display === 'block';
lessonCategoriesEl.style.display = isShown ? 'none' : 'block';
});
document.getElementById('pro-mode-button').addEventListener('click', ()=>{
const categories = Object.keys(LESSON_NOTES_DATA);
const pick = prompt('Enter category name for Pro Mode:\n' + categories.join('\n'), categories[0]);
if (pick && LESSON_NOTES_DATA[pick]) startProMode(pick);
});
document.getElementById('mobile-menu-toggle').addEventListener('click', ()=>{
const sb = document.getElementById('sidebar');
sb.classList.toggle('open');
});

/* history toggle button */
document.getElementById('history-toggle-button').addEventListener('click', ()=>{
historyPanelEl.classList.toggle('hidden');
});

/* ========= NAME INPUT ========= */
const nameInputEl = document.getElementById('name-input');
const nameGreetingEl = document.getElementById('name-greeting');

function loadName(){
try{
const stored = localStorage.getItem(KEY_NAME) || '';
if (stored){
userName = stored;
nameInputEl.value = stored;
nameGreetingEl.textContent = `Hi, ${stored}!`;
}
}catch(e){}
}
function saveName(){
userName = nameInputEl.value.trim();
localStorage.setItem(KEY_NAME, userName);
nameGreetingEl.textContent = userName ? `Hi, ${userName}!` : 'Hi, learner!';
}
nameInputEl.addEventListener('change', saveName);
nameInputEl.addEventListener('keyup', (e)=>{
if (e.key === 'Enter') saveName();
});

/* ========= INITIALIZATION ========= */
function initApp(){
renderLessonLists();
renderHistoryPanel();
renderDashboardStats();
loadName();
const firstCat = Object.keys(LESSON_NOTES_DATA)[0];
if (firstCat) handleStandardLessonSelection(firstCat, 0);
bpmInput.value = bpm;
instrSelect.value = selectedInstrument;
shrutiSelect.value = baseSaFrequency;
}
initApp();

</script>
</body>
</html>
